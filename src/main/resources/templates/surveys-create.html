<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create Survey</title>
  <link rel="stylesheet" th:href="@{/css/survey.css}">
</head>
<body>
  <div class="topnav">
    <a th:href="@{/}">&#8592; Home</a>
  </div>

  <h1>Create Survey</h1>
  <p class="muted">Add questions. For number type you can set an integer range.</p>

  <fieldset>
    <legend>Survey</legend>
    <div class="row">
      <label for="surveyTitle">Title:</label>
      <input id="surveyTitle" type="text" placeholder="e.g., 4806 Survey"/>
    </div>
  </fieldset>

  <fieldset>
    <legend>Add Question</legend>
    <div class="row">
      <label for="qText">Question</label>
      <input id="qText" type="text" placeholder="e.g., What is the best SYSC class?"/>
    </div>
    <div class="spacer"></div>
    <div class="row">
      <label for="qType">Type</label>
      <select id="qType">
        <option value="OPEN_TEXT">Open-ended (text)</option>
        <option value="NUMBER">Number (with optional range)</option>
        <option value="CHOICE">Multiple choice</option>
      </select>
      <button id="addQuestionBtn" class="primary" type="button">Add Question</button>
    </div>

    <!-- NUMBER range inputs -->
    <div id="numberRangeBlock" style="display:none; margin-top:0.75rem;">
      <div class="row">
        <label for="minValue">Min</label>
        <input id="minValue" type="number" placeholder="e.g., 0"/>
        <label for="maxValue">Max</label>
        <input id="maxValue" type="number" placeholder="e.g., 100"/>
      </div>
      <p class="muted">Leave either field empty for no bound.</p>
    </div>

    <!-- CHOICE options -->
    <div id="choiceOptionsBlock" style="display:none; margin-top:0.75rem;">
      <label for="choiceOptions">Choices (one per line):</label>
      <textarea id="choiceOptions" placeholder="Yes
No
Maybe"></textarea>
    </div>
  </fieldset>

  <h2>Questions in this Survey</h2>
  <div id="questionsList"></div>

  <div class="row">
    <button id="saveSurveyBtn" class="primary" type="button">Save Survey</button>
    <span id="status" class="muted"></span>
  </div>

  <hr/>

  <h2>Existing Surveys</h2>
  <p class="muted">Fetched from <code>GET /surveys</code></p>
  <div>
    <button id="refreshBtn" type="button">Refresh List</button>
  </div>
  <ul id="surveysUl"></ul>

<script>
(function() {
  const questions = [];

  const el = (id) => document.getElementById(id);
  const questionsList = el('questionsList');
  const choiceBlock = el('choiceOptionsBlock');
  const numberBlock = el('numberRangeBlock');
  const choiceArea = el('choiceOptions');
  const minInput = el('minValue');
  const maxInput = el('maxValue');
  const qType = el('qType');
  const status = el('status');

  function renderQuestions() {
    questionsList.innerHTML = '';
    if (questions.length === 0) {
      const p = document.createElement('p');
      p.className = 'muted';
      p.textContent = 'No questions added yet.';
      questionsList.appendChild(p);
      return;
    }
    questions.forEach((q, idx) => {
      const div = document.createElement('div');
      div.className = 'question';
      const title = document.createElement('div');
      title.innerHTML = '<strong>Q' + (idx + 1) + ':</strong> ' + q.questionText;
      const meta = document.createElement('div');
      meta.className = 'meta';
      let extra = '';
      if (q.type === 'NUMBER') {
        const r = [];
        if (q.minValue !== null && q.minValue !== undefined) r.push('min=' + q.minValue);
        if (q.maxValue !== null && q.maxValue !== undefined) r.push('max=' + q.maxValue);
        if (r.length) extra = ' · ' + r.join(', ');
      } else if (q.type === 'CHOICE' && q.options && q.options.length) {
        extra = ' · Options: ' + q.options.join(', ');
      }
      meta.textContent = 'Type: ' + q.type + extra;
      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = () => { questions.splice(idx, 1); renderQuestions(); };
      div.appendChild(title);
      div.appendChild(meta);
      div.appendChild(removeBtn);
      questionsList.appendChild(div);
    });
  }

  function toIntOrNull(v) {
    const s = String(v ?? '').trim();
    if (s === '') return null;
    const n = Number(s);
    return Number.isFinite(n) ? Math.trunc(n) : null;
  }

  qType.addEventListener('change', () => {
    const t = qType.value;
    choiceBlock.style.display = (t === 'CHOICE') ? 'block' : 'none';
    numberBlock.style.display = (t === 'NUMBER') ? 'block' : 'none';
  });

  el('addQuestionBtn').addEventListener('click', () => {
    const text = el('qText').value.trim();
    const type = qType.value;
    if (!text) { alert('Please enter the question text.'); return; }

    const q = { questionText: text, type: type, options: [] };

    if (type === 'CHOICE') {
      const lines = choiceArea.value.split('\n').map(s => s.trim()).filter(Boolean);
      q.options = lines;
    }

    if (type === 'NUMBER') {
      const minV = toIntOrNull(minInput.value);
      const maxV = toIntOrNull(maxInput.value);
      if (minV !== null && maxV !== null && minV > maxV) {
        alert('Min must be ≤ Max.');
        return;
      }
      if (minV !== null) q.minValue = minV;
      if (maxV !== null) q.maxValue = maxV;
    }

    questions.push(q);

    // reset all fields
    el('qText').value = '';
    choiceArea.value = '';
    minInput.value = '';
    maxInput.value = '';
    renderQuestions();
  });

  async function saveSurvey() {
    status.textContent = '';
    const title = el('surveyTitle').value.trim();
    if (!title) { status.textContent = 'Please enter a title.'; status.className = 'error'; return; }
    if (questions.length === 0) { status.textContent = 'Please add at least one question.'; status.className = 'error'; return; }

    const payload = { title: title, questions: questions };

    try {
      const resp = await fetch('/surveys', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!resp.ok) { 
        const txt = await resp.text(); throw new Error('Server returned ' + resp.status + ': ' + txt); 
      }
      const saved = await resp.json();
      const savedId = (saved.id ?? saved.surveyId ?? saved.idSurvey ?? saved.ID ?? saved.Id);
      const savedTitle = (saved.title ?? saved.name ?? title ?? '(untitled)');

      status.textContent = 'Saved survey #' + (savedId ?? 'unknown') + ' (' + savedTitle + ').';
      status.className = 'success';

      // Clear all fields
      el('surveyTitle').value = '';
      questions.length = 0; 
      renderQuestions();
      choiceArea.value = '';
      minInput.value = '';
      maxInput.value = '';

      loadSurveys();
    } catch (e) {
      status.textContent = e.message;
      status.className = 'error';
    }
  }

  async function loadSurveys() {
    const ul = el('surveysUl');
    ul.innerHTML = '';
    try {
      const resp = await fetch('/surveys', { method: 'GET' });
      if (!resp.ok) throw new Error('Failed to fetch surveys: ' + resp.status);
      const data = await resp.json();
      if (!Array.isArray(data) || data.length === 0) {
        const li = document.createElement('li'); li.className = 'muted'; li.textContent = 'No surveys yet.'; ul.appendChild(li); return;
        }
      data.forEach(s => {
        const li = document.createElement('li');
        const title = document.createElement('span');
        title.innerHTML = '<strong>#' + s.id + '</strong> — ' + (s.title || '(untitled)');
        li.appendChild(title);

        const btn = document.createElement('button');
        btn.style.marginLeft = '0.5rem'; btn.textContent = 'View JSON';
        btn.onclick = async () => {
          try { const r = await fetch('/surveys/' + s.id); const j = await r.json(); alert(JSON.stringify(j, null, 2)); } catch (_) {}
        };
        li.appendChild(btn);
        ul.appendChild(li);
      });
    } catch (e) {
      const li = document.createElement('li'); li.className = 'error'; li.textContent = e.message; ul.appendChild(li);
    }
  }

  el('saveSurveyBtn').addEventListener('click', saveSurvey);
  el('refreshBtn').addEventListener('click', loadSurveys);

  renderQuestions();
  loadSurveys();
})();
</script>
</body>
</html>