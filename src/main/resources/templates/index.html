<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mini Survey Monkey</title>
    <link rel="stylesheet" th:href="@{/css/survey.css}">
</head>
<body>

<div class="topnav">
    <a th:href="@{/}">&#8592; Home</a>
    <form th:action="@{/logout}" method="post">
        <input type="submit" value="Sign Out" class="sign-out"/>
    </form>
</div>

<h1>Mini Survey Monkey</h1>
<p class="muted">Create new surveys or revisit your existing ones.</p>

<section class="card create-section">
    <h2>Create a new survey</h2>
    <p class="muted">Start a new survey and add your own questions.</p>
    <a class="button primary" th:href="@{/surveys/new}">+ Create Survey</a>
</section>

<section class="card existing-section">
    <div class="existing-header">
        <h2>Existing Surveys</h2>
        <button id="refreshBtn" class="button secondary" type="button">Refresh</button>
    </div>

    <ul id="surveysUl">
        <li class="no-surveys muted">No surveys yet.</li>
    </ul>
</section>

<script>
    async function loadSurveys() {
        const ul = document.getElementById('surveysUl');
        ul.innerHTML = '<li class="muted">Loading…</li>';

        try {
            const resp = await fetch('/surveys');
            if (!resp.ok) {
                throw new Error('Failed to load surveys');
            }

            const data = await resp.json();
            ul.innerHTML = '';

            if (!Array.isArray(data) || data.length === 0) {
                ul.innerHTML = '<li class="no-surveys muted">No surveys yet.</li>';
                return;
            }

            data.forEach(s => {
                const li = document.createElement('li');
                li.className = 'survey-item';

                const title = document.createElement('div');
                title.className = 'survey-title';
                title.textContent = `#${s.id} — ${s.title || '(untitled survey)'}`;

                const actions = document.createElement('div');
                actions.className = 'survey-actions';

                // Preview
                const preview = document.createElement('a');
                preview.href = `/surveys/${s.id}/preview`;
                preview.textContent = 'Preview';
                preview.className = 'action-link';
                actions.appendChild(preview);

                // Take
                const take = document.createElement('a');
                take.href = `/surveys/${s.id}/response`;
                take.textContent = 'Take';
                take.className = 'action-link primary';
                actions.appendChild(take);

                // Close/Reopen
                const toggle = document.createElement('a');
                toggle.textContent = s.closed ? 'Reopen' : 'Close';
                toggle.className = 'action-link';
                toggle.href = '#';
                toggle.onclick = async (e) => {
                    e.preventDefault();
                    const action = s.closed ? 'reopen' : 'close';
                    if (!confirm(`Are you sure you want to ${action} survey #${s.id}?`)) return;

                    const r = await fetch(`/surveys/${s.id}/close`, { method: 'POST' });
                    if (r.ok) {
                        loadSurveys();
                    } else {
                        alert('Failed to update survey status');
                    }
                };
                actions.appendChild(toggle);

                // Delete
                const del = document.createElement('a');
                del.textContent = 'Delete';
                del.className = 'action-link';
                del.href = '#';
                del.onclick = async (e) => {
                    e.preventDefault();
                    if (!confirm(`Delete survey #${s.id}?`)) return;

                    const r = await fetch(`/surveys/${s.id}`, { method: 'DELETE' });
                    if (r.ok) {
                        loadSurveys();
                    } else {
                        alert('Failed to delete survey');
                    }
                };
                actions.appendChild(del);

                // Share
                const share = document.createElement('a');
                share.textContent = 'Share';
                share.className = 'action-link';
                share.href = '#';
                share.onclick = async (e) => {
                    e.preventDefault();
                    try {
                        const r = await fetch(`/surveys/${s.id}/share`);
                        if (!r.ok) {
                            alert('Failed to fetch share link');
                            return;
                        }
                        const link = await r.text();

                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(link);
                            alert('Share link copied to clipboard:\n' + link);
                        } else {
                            // Fallback if clipboard API not available
                            prompt('Copy this link:', link);
                        }
                    } catch (err) {
                        alert('Error while generating share link');
                    }
                };
                actions.appendChild(share);

                li.appendChild(title);
                li.appendChild(actions);
                ul.appendChild(li);
            });

        } catch (e) {
            ul.innerHTML = `<li class="error">${e.message}</li>`;
        }
    }

    document.getElementById('refreshBtn').addEventListener('click', loadSurveys);
    loadSurveys();
</script>

</body>
</html>
